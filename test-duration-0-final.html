<!DOCTYPE html>
<html>
<head>
    <title>Test Duration 0 Completely Fixed</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .result { margin: 10px 0; padding: 10px; }
        .pass { background-color: #d4edda; color: #155724; }
        .fail { background-color: #f8d7da; color: #721c24; }
        pre { background: #f8f9fa; padding: 10px; }
    </style>
</head>
<body>
    <h1>Test Duration 0 Completely Fixed</h1>
    <div id="results"></div>
    
    <script src="js/storage.js"></script>
    <script src="js/audio-engine.js"></script>
    <script src="js/main.js"></script>
    <script>
        const results = document.getElementById('results');
        const player = new MusicPlayer();
        
        // Override audio functions to track calls
        let audioCalls = [];
        const audioFunctions = ['scheduleHit', 'playPianoTone', 'playStringTone', 'playElectricGuitarTone', 'playAcousticGuitarTone', 'playHiHatBeat', 'playKickBeat', 'playSnareBeat', 'playClapBeat'];
        
        audioFunctions.forEach(funcName => {
            const originalFunc = player[funcName].bind(player);
            player[funcName] = function(...args) {
                audioCalls.push({
                    function: funcName,
                    args: args,
                    duration: args[2] || 0
                });
                return originalFunc(...args);
            };
        });
        
        // Test patterns
        const beatPattern = [
            {"beat": "kick", "dur": 1},
            {"beat": "snare", "dur": 0},  // Should be completely ignored
            {"beat": "hihat", "dur": 0.5}
        ];
        
        const melodyPattern = [
            {"note": "C4", "dur": 1},
            {"note": "D4", "dur": 0},  // Should be completely ignored
            {"note": "E4", "dur": 0.5}
        ];
        
        results.innerHTML += '<h2>Testing Beat Pattern</h2>';
        results.innerHTML += '<pre>' + JSON.stringify(beatPattern, null, 2) + '</pre>';
        
        // Reset and test beat pattern
        audioCalls = [];
        player.playBeatPattern(beatPattern, 120);
        
        // Filter for duration 0 calls
        const zeroDurationCalls = audioCalls.filter(call => call.duration <= 0);
        const snareCalls = audioCalls.filter(call => 
            call.function === 'scheduleHit' && call.args[0] === 'snare'
        );
        
        results.innerHTML += `<div class="result ${zeroDurationCalls.length === 0 ? 'pass' : 'fail'}">
            ${zeroDurationCalls.length === 0 ? '✅' : '❌'} Zero duration audio calls: ${zeroDurationCalls.length} (should be 0)
        </div>`;
        
        results.innerHTML += `<div class="result ${snareCalls.length === 0 ? 'pass' : 'fail'}">
            ${snareCalls.length === 0 ? '✅' : '❌'} Snare calls: ${snareCalls.length} (should be 0)
        </div>`;
        
        results.innerHTML += '<h2>Testing Melody Pattern</h2>';
        results.innerHTML += '<pre>' + JSON.stringify(melodyPattern, null, 2) + '</pre>';
        
        // Reset and test melody pattern
        audioCalls = [];
        player.playMelodyPattern(melodyPattern, 120);
        
        // Filter for duration 0 calls
        const zeroDurationMelodyCalls = audioCalls.filter(call => call.duration <= 0);
        const d4Freq = player.noteToFrequency('D4');
        const d4Calls = audioCalls.filter(call => 
            call.args[0] === d4Freq
        );
        
        results.innerHTML += `<div class="result ${zeroDurationMelodyCalls.length === 0 ? 'pass' : 'fail'}">
            ${zeroDurationMelodyCalls.length === 0 ? '✅' : '❌'} Zero duration audio calls: ${zeroDurationMelodyCalls.length} (should be 0)
        </div>`;
        
        results.innerHTML += `<div class="result ${d4Calls.length === 0 ? 'pass' : 'fail'}">
            ${d4Calls.length === 0 ? '✅' : '❌'} D4 calls: ${d4Calls.length} (should be 0)
        </div>`;
        
        // Test visualization
        results.innerHTML += '<h2>Testing Visualization</h2>';
        
        player.beatInput.value = JSON.stringify(beatPattern);
        player.melodyInput.value = JSON.stringify(melodyPattern);
        
        player.visualizePattern('beat');
        player.visualizePattern('melody');
        
        const beatVizItems = player.beatViz.querySelectorAll('.viz-item').length;
        const melodyVizItems = player.melodyViz.querySelectorAll('.viz-item').length;
        
        results.innerHTML += `<div class="result ${beatVizItems === 2 ? 'pass' : 'fail'}">
            ${beatVizItems === 2 ? '✅' : '❌'} Beat visualization items: ${beatVizItems} (should be 2)
        </div>`;
        
        results.innerHTML += `<div class="result ${melodyVizItems === 2 ? 'pass' : 'fail'}">
            ${melodyVizItems === 2 ? '✅' : '❌'} Melody visualization items: ${melodyVizItems} (should be 2)
        </div>`;
        
        // Test duration calculation
        const beatDuration = player.calculatePatternDuration(beatPattern, 'beat');
        const melodyDuration = player.calculatePatternDuration(melodyPattern, 'melody');
        
        results.innerHTML += `<div class="result ${Math.abs(beatDuration - 1.5) < 0.001 ? 'pass' : 'fail'}">
            ${Math.abs(beatDuration - 1.5) < 0.001 ? '✅' : '❌'} Beat duration: ${beatDuration} (should be 1.5)
        </div>`;
        
        results.innerHTML += `<div class="result ${Math.abs(melodyDuration - 1.5) < 0.001 ? 'pass' : 'fail'}">
            ${Math.abs(melodyDuration - 1.5) < 0.001 ? '✅' : '❌'} Melody duration: ${melodyDuration} (should be 1.5)
        </div>`;
        
        results.innerHTML += '<h2>Summary</h2>';
        results.innerHTML += '<p>Duration 0 items should now be completely ignored in:</p>';
        results.innerHTML += '<ul><li>Audio scheduling (no sound)</li><li>Visualization (not displayed)</li><li>Duration calculation (not counted)</li></ul>';
    </script>
</body>
</html>