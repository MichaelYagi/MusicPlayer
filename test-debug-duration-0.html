<!DOCTYPE html>
<html>
<head>
    <title>Debug Duration 0 Issue</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug { background: #f0f0f0; padding: 10px; margin: 10px 0; }
        .error { background: #ffe6e6; color: red; }
        .success { background: #e6ffe6; color: green; }
    </style>
</head>
<body>
    <h1>Debug Duration 0 Issue</h1>
    <div id="debug"></div>
    
    <script src="js/storage.js"></script>
    <script src="js/audio-engine.js"></script>
    <script src="js/main.js"></script>
    <script>
        const debug = document.getElementById('debug');
        let player;
        
        // Initialize player
        try {
            player = new MusicPlayer();
            debug.innerHTML += '<div class="success">‚úÖ Player initialized</div>';
        } catch (error) {
            debug.innerHTML += `<div class="error">‚ùå Player init failed: ${error.message}</div>`;
        }
        
        // Override scheduleHit to track calls
        let scheduleHitCalls = [];
        const originalScheduleHit = player.scheduleHit.bind(player);
        player.scheduleHit = function(...args) {
            scheduleHitCalls.push({
                beat: args[0],
                startTime: args[1],
                duration: args[2],
                volume: args[3],
                timestamp: Date.now()
            });
            debug.innerHTML += `<div class="debug">üîµ scheduleHit called: ${args[0]} (duration: ${args[2]}s)</div>`;
            return originalScheduleHit(...args);
        };
        
        // Override playNote functions to track calls
        let playNoteCalls = [];
        const originalPlayPianoTone = player.playPianoTone.bind(player);
        player.playPianoTone = function(...args) {
            playNoteCalls.push({type: 'piano', args});
            debug.innerHTML += `<div class="debug">üéπ playPianoTone called: freq=${args[0]}, duration=${args[2]}s</div>`;
            return originalPlayPianoTone(...args);
        };
        
        // Test beat pattern with duration 0
        const testBeatPattern = [
            {"beat": "kick", "dur": 1},
            {"beat": "snare", "dur": 0},  // Should be ignored
            {"beat": "hihat", "dur": 0.5}
        ];
        
        debug.innerHTML += '<h3>Testing Beat Pattern:</h3>';
        debug.innerHTML += `<pre>${JSON.stringify(testBeatPattern, null, 2)}</pre>`;
        
        // Reset counters
        scheduleHitCalls = [];
        
        try {
            player.playBeatPattern(testBeatPattern, 120);
            
            setTimeout(() => {
                debug.innerHTML += `<h3>Results after 100ms:</h3>`;
                debug.innerHTML += `<div>scheduleHit calls: ${scheduleHitCalls.length}</div>`;
                scheduleHitCalls.forEach((call, i) => {
                    debug.innerHTML += `<div class="debug">Call ${i+1}: ${call.beat} (duration: ${call.duration}s)</div>`;
                });
                
                // Check if snare (duration 0) was called
                const snareCalls = scheduleHitCalls.filter(call => call.beat === 'snare');
                if (snareCalls.length === 0) {
                    debug.innerHTML += '<div class="success">‚úÖ Snare (duration 0) was NOT scheduled - GOOD!</div>';
                } else {
                    debug.innerHTML += `<div class="error">‚ùå Snare (duration 0) was scheduled ${snareCalls.length} times - BAD!</div>`;
                }
                
                // Test melody pattern
                debug.innerHTML += '<h3>Testing Melody Pattern:</h3>';
                const testMelodyPattern = [
                    {"note": "C4", "dur": 1},
                    {"note": "D4", "dur": 0},  // Should be ignored
                    {"note": "E4", "dur": 0.5}
                ];
                
                debug.innerHTML += `<pre>${JSON.stringify(testMelodyPattern, null, 2)}</pre>`;
                
                playNoteCalls = [];
                player.playMelodyPattern(testMelodyPattern, 120);
                
                setTimeout(() => {
                    debug.innerHTML += `<h3>Melody Results after 100ms:</h3>`;
                    debug.innerHTML += `<div>playNote calls: ${playNoteCalls.length}</div>`;
                    playNoteCalls.forEach((call, i) => {
                        debug.innerHTML += `<div class="debug">Call ${i+1}: ${call.type} - freq=${call.args[0]}, duration=${call.args[2]}s</div>`;
                    });
                    
                    // Check if D4 (duration 0) was called
                    const d4Calls = playNoteCalls.filter(call => call.args[0] === player.noteToFrequency('D4'));
                    if (d4Calls.length === 0) {
                        debug.innerHTML += '<div class="success">‚úÖ D4 (duration 0) was NOT scheduled - GOOD!</div>';
                    } else {
                        debug.innerHTML += `<div class="error">‚ùå D4 (duration 0) was scheduled ${d4Calls.length} times - BAD!</div>`;
                    }
                }, 100);
                
            }, 100);
            
        } catch (error) {
            debug.innerHTML += `<div class="error">‚ùå Test failed: ${error.message}</div>`;
        }
    </script>
</body>
</html>