<!DOCTYPE html>
<html>
<head>
    <title>Test Duration 0 Items Ignored</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .result { margin: 10px 0; padding: 10px; }
        .pass { background-color: #d4edda; color: #155724; }
        .fail { background-color: #f8d7da; color: #721c24; }
        pre { background: #f8f9fa; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>Test Duration 0 Items Ignored</h1>
    <div id="results"></div>
    
    <script src="js/storage.js"></script>
    <script src="js/audio-engine.js"></script>
    <script src="js/main.js"></script>
    <script>
        const results = document.getElementById('results');
        let player;
        
        // Initialize player
        try {
            player = new MusicPlayer();
            results.innerHTML += '<div class="result pass">✅ Player initialized successfully</div>';
        } catch (error) {
            results.innerHTML += `<div class="result fail">❌ Player initialization failed: ${error.message}</div>`;
        }
        
        // Test patterns with duration 0 items
        const testPatterns = {
            beat: [
                {"beat": "kick", "dur": 1},
                {"beat": "rest", "dur": 0},  // Should be ignored
                {"beat": "snare", "dur": 1},
                {"beat": "rest", "dur": 0},  // Should be ignored
                {"beat": "hihat", "dur": 0.5}
            ],
            melody: [
                {"note": "C4", "dur": 1},
                {"note": "rest", "dur": 0},  // Should be ignored
                {"note": "E4", "dur": 1},
                {"note": "rest", "dur": 0},  // Should be ignored
                {"note": "G4", "dur": 0.5}
            ]
        };
        
        // Test validation (should accept duration 0)
        const storage = new StorageModule();
        const beatValid = storage.validatePattern(testPatterns.beat, 'beat');
        const melodyValid = storage.validatePattern(testPatterns.melody, 'melody');
        
        results.innerHTML += `<div class="result ${beatValid ? 'pass' : 'fail'}">
            ${beatValid ? '✅' : '❌'} Beat pattern validation (should accept duration 0): ${beatValid}
        </div>`;
        
        results.innerHTML += `<div class="result ${melodyValid ? 'pass' : 'fail'}">
            ${melodyValid ? '✅' : '❌'} Melody pattern validation (should accept duration 0): ${melodyValid}
        </div>`;
        
        // Test duration calculation (should ignore duration 0)
        const beatDuration = player.calculatePatternDuration(testPatterns.beat, 'beat');
        const melodyDuration = player.calculatePatternDuration(testPatterns.melody, 'melody');
        
        const expectedBeatDuration = 1 + 1 + 0.5; // 2.5 (ignoring the two 0-duration rests)
        const expectedMelodyDuration = 1 + 1 + 0.5; // 2.5 (ignoring the two 0-duration rests)
        
        results.innerHTML += `<div class="result ${Math.abs(beatDuration - expectedBeatDuration) < 0.001 ? 'pass' : 'fail'}">
            ${Math.abs(beatDuration - expectedBeatDuration) < 0.001 ? '✅' : '❌'} Beat duration calculation: ${beatDuration} (expected ${expectedBeatDuration})
        </div>`;
        
        results.innerHTML += `<div class="result ${Math.abs(melodyDuration - expectedMelodyDuration) < 0.001 ? 'pass' : 'fail'}">
            ${Math.abs(melodyDuration - expectedMelodyDuration) < 0.001 ? '✅' : '❌'} Melody duration calculation: ${melodyDuration} (expected ${expectedMelodyDuration})
        </div>`;
        
        // Test visualization (should not show duration 0 items)
        try {
            // Set the patterns in the inputs
            if (player.beatInput && player.melodyInput) {
                player.beatInput.value = JSON.stringify(testPatterns.beat, null, 2);
                player.melodyInput.value = JSON.stringify(testPatterns.melody, null, 2);
                
                // Generate visualizations
                player.visualizePattern('beat');
                player.visualizePattern('melody');
                
                // Check if visualization elements were created (should be 3 each, not 5)
                const beatVizItems = player.beatViz ? player.beatViz.querySelectorAll('.viz-item').length : 0;
                const melodyVizItems = player.melodyViz ? player.melodyViz.querySelectorAll('.viz-item').length : 0;
                
                results.innerHTML += `<div class="result ${beatVizItems === 3 ? 'pass' : 'fail'}">
                    ${beatVizItems === 3 ? '✅' : '❌'} Beat visualization items: ${beatVizItems} (expected 3, not 5)
                </div>`;
                
                results.innerHTML += `<div class="result ${melodyVizItems === 3 ? 'pass' : 'fail'}">
                    ${melodyVizItems === 3 ? '✅' : '❌'} Melody visualization items: ${melodyVizItems} (expected 3, not 5)
                </div>`;
            }
        } catch (error) {
            results.innerHTML += `<div class="result fail">❌ Visualization test failed: ${error.message}</div>`;
        }
        
        results.innerHTML += `
            <div class="test-section">
                <h3>Test Patterns Used:</h3>
                <pre>${JSON.stringify(testPatterns, null, 2)}</pre>
            </div>
        `;
    </script>
</body>
</html>